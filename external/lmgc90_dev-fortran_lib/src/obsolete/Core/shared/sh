! rm: Example taken from test_dict.f90 of the flibs
module contact_laws

implicit none

! The length of the keys : length of contact laws name
integer, parameter :: dict_key_length = 30

! A type for defining a new contact law type
type T_contact_law
  integer(kind=4)   :: id
  integer(kind=4)   :: nb_param
  integer(kind=4)   :: nb_internal
  character(len=75) :: internal_comment
  !
  character(len=5), dimension(:), pointer :: param_name => null()
end type

!
! The "null" value for these data
!
type(T_contact_law), parameter :: DICT_NULL = t_contact_law( 0, 0, 0, '', null() )

end module

module contact_laws_dict

    use contact_laws, DICT_DATA => T_contact_law

    include "dictionary.f90"

    subroutine tact_behav_info_from_dict(dict,key,id,nb_param,param_name,nb_internal,internal_comment)
      implicit none
      type(dict_struct), pointer :: dict
      character(len=30) :: key
      integer           :: id,nb_param,nb_internal
      character(len=75) :: internal_comment
      character(len=5), dimension(:), pointer :: param_name
      !
      type(DICT_DATA)   :: data
                               !1234567890123456789012345678901234567
      character(len=37) :: IAM='tact_behav::tact_behav_info_from_dict'
      character(len=80) :: cout

      data = dict_get_key(dict,key)

      id          = data%id
      nb_param    = data%nb_param
      nb_internal = data%nb_internal

      param_name => data%param_name

      internal_comment = data%internal_comment
    end subroutine

end module contact_laws_dict

program test_contact_laws_dict

    use timer

    use tact_behaviour, only : tact_behav_info

    use contact_laws_dict

    implicit none

    type(DICT_STRUCT), pointer     :: dict
    type(DICT_DATA)                :: data
    character(len=DICT_KEY_LENGTH) :: key(65)

    integer(kind=4) :: id_cl, n_tests, i_rand, id_info, id_dict, i
    integer(kind=4) :: id, id2, nb_param, nb_param2, nb_internal, nb_internal2
    real(kind=8)    :: r_rand
    character(len=5),dimension(:),pointer :: param_name, param_name2
    character(len=75)                     :: internal_comment, internal_comment2

    nullify(param_name)
    nullify(param_name2)

    n_tests = 3000000
    data%internal_comment =  '#                                                                          '

    ! Create a dictionary with contact laws
    id_cl = 1

    ! all with nb_param = 0 et nb_internal = 1
    key(id_cl) = 'TEX_SOL_UNILAT'
    data%id = id_cl
    data%nb_param = 0
    data%nb_internal = 1
    data%internal_comment( 2:15) = 'gapREF        '
    call dict_create( dict, key(id_cl), data )
    id_cl = id_cl + 1

    ! all with nb_param = 1 et nb_internal = 0
    key(id_cl) = 'IQS_CLB'
    data%id = id_cl
    data%nb_param = 1
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'sfric'
    data%internal_comment =  '#                                                                          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'IQS_CLB_nosldt'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'IQS_CLB_noslds'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'TEX_SOL'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    ! all with nb_param = 1 et nb_internal = 1
    key(id_cl) = 'IQS_CLB_g0'
    data%id = id_cl
    data%nb_internal = 1
    data%internal_comment( 2:15) = 'g_ref         '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'IQS_MAP'
    data%id = id_cl
    data%internal_comment( 2:15) = 'fric          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'GAP_SGR_CLB'
    data%id = id_cl
    data%internal_comment( 2:15) = 'taille ele    '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'VEL_SGR_CLB'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    ! all with nb_param = 1 et nb_internal = 2
    key(id_cl) = 'GAP_SGR_CLB_g0'
    data%id = id_cl
    data%nb_internal = 2
    data%internal_comment( 2:15) = 'taille ele    '
    data%internal_comment(17:30) = 'g_ref         '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 2 et nb_internal = 0
    key(id_cl) = 'IQS_DS_CLB'
    data%id = id_cl
    data%nb_param = 2
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'dfric'
    data%param_name(2) = 'sfric'
    data%internal_comment =  '#                                                                          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    ! all with nb_param = 2 et nb_internal = 1
    key(id_cl) = 'GAP_SGR_DS_CLB'
    data%id = id_cl
    data%nb_internal = 1
    data%internal_comment( 2:15) = 'taille ele    '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'VEL_SGR_DS_CLB'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 3 et nb_internal = 0
    key(id_cl) = 'IQS_CLB_RGR'
    data%id = id_cl
    data%nb_param = 3
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'T/H  '
    data%param_name(2) = 'gTot '
    data%param_name(3) = 'sfric'
    data%internal_comment =  '#                                                                          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'RST_CLB'
    data%id = id_cl
    data%param_name(1) = 'restn'
    data%param_name(2) = 'restt'
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 4 et nb_internal = 0
    key(id_cl) = 'RST_DS_CLB'
    data%id = id_cl
    data%nb_param = 4
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'restn'
    data%param_name(2) = 'restt'
    data%param_name(3) = 'dfric'
    data%param_name(4) = 'sfric'
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'IQS_MOHR_DS_CLB'
    data%id = id_cl
    data%param_name(1) = 'cohen'
    data%param_name(2) = 'cohet'
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'GAP_MOHR_DS_CLB'
    data%id = id_cl
    data%param_name(1) = 'cohen'
    data%param_name(2) = 'cohet'
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 5 et nb_internal = 0
    key(id_cl) = 'IQS_WET_DS_CLB'
    data%id = id_cl
    data%nb_param = 5
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'cohen'
    data%param_name(2) = 'cohet'
    data%param_name(3) = 'Wethk'
    data%param_name(4) = 'dfric'
    data%param_name(5) = 'sfric'
    data%internal_comment =  '#                                                                          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    key(id_cl) = 'xQS_WET_DS_CLB'
    data%id = id_cl
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    ! all with nb_param = 5 et nb_internal = 1
    key(id_cl) = 'GAP_WET_DS_CLB'
    data%id = id_cl
    data%nb_internal = 1
    data%internal_comment( 2:15)  = 'taille ele    '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 6 et nb_internal = 4
    key(id_cl) = 'IQS_BW_CLB'
    data%id = id_cl
    data%nb_param = 6
    data%nb_internal = 4
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'Afric'
    data%param_name(2) = 'Bfric'
    data%param_name(3) = 'Atsld'
    data%param_name(4) = 'Btsld'
    data%param_name(5) = 'Alpha'
    data%param_name(6) = 'VtTsh'
    data%internal_comment( 2:15) = 'cycle number  '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    ! all with nb_param = 7 et nb_internal = 0
    key(id_cl) = 'RST_WET_CLB'
    data%id = id_cl
    data%nb_param = 7
    data%nb_internal = 0
    allocate(data%param_name(data%nb_param))
    data%param_name(1) = 'cohen'
    data%param_name(2) = 'cohet'
    data%param_name(3) = 'restn'
    data%param_name(4) = 'restt'
    data%param_name(5) = 'Wethk'
    data%param_name(6) = 'dfric'
    data%param_name(7) = 'sfric'
    data%internal_comment = '#                                                                          '
    call dict_add_key( dict, key(id_cl), data )
    id_cl = id_cl + 1

    deallocate(data%param_name)

    !!!!!-----------------------------------------
    !!CASE('IQS_CAP_MOHR_DS_CLB               ')
    !!  id = i_IQS_CAP_MOHR_DS_CLB
    !!  nb_param = 6
    !!  !IF(ASSOCIATED(param_name)) DEALLOCATE(param_name)
    !!  ALLOCATE(param_name(nb_param))
    !!  param_name(1) = 'cohen'
    !!  param_name(2) = 'cohet'
    !!  param_name(3) = 'dfric'
    !!  param_name(4) = 'sfric'
    !!  param_name(5) = 's_ten'
    !!  param_name(6) = 's_com'

    !! and ohters...

    ! Retrieve a particular key ...
    write(*,*) 'Has "IQS_CLB"? ', dict_has_key(dict, 'IQS_CLB' )
    write(*,*) 'Has "IQS_nosldt"? ', dict_has_key(dict, 'IQS_nosldt' )
    write(*,*) 'Has "IQS_CLB_nosldt"? ', dict_has_key(dict, 'IQS_CLB_nosldt' )

    ! Retrieve the value for 'IQS_CLB'
    data = dict_get_key(dict,'IQS_CLB')
    write(*,*) 'IQS_CLB : '
    write(*,*) 'id          = ', data%id
    write(*,*) 'nb_param    = ', data%nb_param
    write(*,*) 'nb_internal = ', data%nb_internal
    if( data%nb_param > 0 ) write(*,*) 'param_name  = ', data%param_name
    write(*,*) 'internal_comment = ', data%internal_comment

    data = dict_get_key(dict,'RST_WET_CLB')
    write(*,*) 'IQS_CLB : '
    write(*,*) 'id          = ', data%id
    write(*,*) 'nb_param    = ', data%nb_param
    write(*,*) 'nb_internal = ', data%nb_internal
    if( data%nb_param > 0 ) write(*,*) 'param_name  = ', data%param_name
    write(*,*) 'internal_comment = ', data%internal_comment

    call initialize_timer()
    id_info = get_new_timer_id('select case         ')
    id_dict = get_new_timer_id('hashkey with dict   ')

    ! now we time try n_tests times
    do i = 1, n_tests

      !print *, 'test number : ', i

      !generate a random integer number between 1 and id_cl that is now the number of keys
      call random_number( r_rand )
      i_rand = 1 + int( (id_cl-1) * r_rand )
      !print *, '    looking for key : ', key(i_rand)

      call start_timer(id_info)
      call tact_behav_info(key(i_rand), id, nb_param, param_name, nb_internal, internal_comment)
      call stop_timer(id_info)

      call start_timer(id_dict)
      call tact_behav_info_from_dict(dict,key(i_rand), id2, nb_param2, param_name2, nb_internal2, internal_comment2)
      call stop_timer(id_dict)

      if( &!id               /= id2          .or. &
          nb_param         /= nb_param2    .or. &
          nb_internal      /= nb_internal2 .or. &
          internal_comment /= internal_comment2 ) then

         print *, '    different results for key : ', key(i_rand)
         write(*,*) '    id = ', id, id2
         write(*,*) '    nb_param = ', nb_param, nb_param2
         write(*,*) '    nb_internal = ', nb_internal, nb_internal2
         write(*,*) 'internal_comment  = ', internal_comment
         write(*,*) 'internal_comment2 = ', internal_comment2
         stop 1
      else
        if( nb_param > 0 ) then
          if( any(param_name(1:nb_param) /= param_name2(1:nb_param)) ) then
            print *, '    different results for key : ', key(i_rand)
            write(*,*) 'param_name  = ', param_name
            write(*,*) 'param_name2 = ', param_name2
            stop 1
          end if
        end if
      end if
      if( associated(param_name) ) then
        deallocate(param_name)
        nullify(param_name)
      end if
      if( associated(param_name2) ) then
        nullify(param_name2)
      end if

    end do

    call write_timer(6)

    ! Destroy the dictionary
    print *,'destroying dict...'
    call dict_destroy( dict )

end program
